<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AnythingWithAI Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Modern fonts from Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0; background: #fff;
      font-family: 'Inter', 'Poppins', sans-serif; color: #222;
      min-height: 100vh;
    }
    .app-header {
      font-size: 1.6rem;
      font-weight: 600;
      padding: 1rem 2rem;
      border-bottom: 1px solid #eee;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      letter-spacing: 1px;
    }
    .container {
      display: flex;
      min-height: calc(100vh - 64px);
      background: #fff;
    }
    .sidebar {
      width: 260px; background: #fafbfc;
      border-right: 1px solid #eee;
      padding: 2rem 1rem 1rem 1rem;
      box-shadow: 2px 0 14px #f5f6f8;
      display: flex; flex-direction: column;
      gap: 1.5rem;
    }
    .sidebar button, .sidebar .logout-btn {
      width: 100%; padding: 0.8em;
      border: none; border-radius: 8px;
      font-weight: 600; font-size: 1rem;
      background: #222; color: #fff; margin-bottom: 0.8em;
      cursor: pointer; transition: background 0.15s;
    }
    .sidebar button:hover, .sidebar .logout-btn:hover { background: #444; }
    .chat-list {
      flex: 1; overflow-y: auto;
      margin-bottom: 2rem;
    }
    .chat-list-title { font-size: 1rem; margin-bottom: 0.5em; font-weight: 600; color: #333;}
    .chat-title {
      background: #f2f3f5; margin-bottom: 6px;
      border-radius: 6px; padding: 0.5em 1em;
      cursor: pointer; font-size: 1rem;
      transition: background 0.12s;
    }
    .chat-title.active, .chat-title:hover { background: #e5e7eb; }
    .sidebar .logout-btn {
      background: #F44336; color: #fff; margin-top: auto;
    }
    .chat-main {
      flex: 1; display: flex; flex-direction: column;
      justify-content: flex-end; align-items: stretch;
      background: #fff;
      padding: 0 0 0 0;
      min-height: 0;
    }
    .chat-area {
      flex: 1; padding: 2rem 2rem 1.5rem 2rem;
      overflow-y: auto; background: #fff;
      max-height: calc(100vh - 140px);
    }
    .message-row { display: flex; margin-bottom: 1rem;}
    .chat-bubble {
      padding: 0.9em 1.2em;
      border-radius: 16px;
      max-width: 75%;
      font-size: 1.05em;
      box-shadow: 0 2px 8px #eee;
      line-height: 1.6;
      word-break: break-word;
      background: #f2f3f5;
      margin-top: 2px;
    }
    .ai { background: #e5e7eb; color: #222;}
    .user { background: #222; color: #fff; margin-left: auto;}
    /* Typing animation */
    .typing {
      display: inline-block; width: 64px; height: 22px;
      vertical-align: middle;
      background: url('https://i.imgur.com/6qXcW60.gif') center center no-repeat;
      background-size: 48px 22px;
    }
    .input-row {
      display: flex; gap: 10px;
      padding: 1rem 2rem 1.3rem 2rem;
      border-top: 1px solid #eee; background: #fff;
    }
    .input-row input[type="text"] {
      flex: 1; font-size: 1.08em;
      padding: 0.7em 1em; border-radius: 10px;
      border: 1px solid #ddd; outline: none;
      background: #fafbfc;
    }
    .input-row button {
      background: #222; color: #fff;
      border: none; border-radius: 10px;
      padding: 0.7em 1.4em; font-size: 1em;
      cursor: pointer; font-weight: 600;
      transition: background 0.15s;
    }
    .input-row button:hover { background: #444; }

    /* Auth styles */
    .auth-bg {
      background: #fff; min-height: 100vh;
      display: flex; align-items: center; justify-content: center;
    }
    .auth-box {
      background: #fff;
      padding: 2.2rem 2.5rem 1.5rem 2.5rem;
      border-radius: 14px;
      box-shadow: 0 6px 36px #e8e7ee;
      width: 100%; max-width: 350px;
      display: flex; flex-direction: column; gap: 1.3rem;
    }
    .auth-box h2 { font-size: 1.32rem; font-weight: 600; text-align: center;}
    .auth-box input {
      font-size: 1em;
      padding: 0.8em 1em;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 1.2em;
      outline: none;
      background: #fafbfc;
    }
    .auth-box button, .google-btn {
      background: #222; color: #fff;
      border: none; border-radius: 8px;
      padding: 0.8em 1.2em;
      font-size: 1em; font-weight: 600;
      cursor: pointer; transition: background 0.15s;
      width: 100%;
      margin-bottom: 0.5em;
    }
    .google-btn {
      background: #4285F4;
      display: flex; align-items: center; justify-content: center;
      gap: 0.8em;
    }
    .google-btn img {
      width: 22px; height: 22px;
    }
    .switch-auth {
      text-align: center;
      font-size: 0.97em; color: #555; margin-top: 0.7em;
      cursor: pointer; text-decoration: underline;
    }
    @media (max-width: 700px) {
      .container { flex-direction: column;}
      .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #eee; flex-direction: row; gap: 1rem; padding: 1rem;}
      .chat-main { padding: 0;}
      .chat-area { padding: 1rem 6vw 1rem 6vw;}
      .input-row { padding: 1rem 6vw 1rem 6vw;}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="app-header">AnythingWithAI</div>

  <!-- Auth UI (hidden after login) -->
  <div class="auth-bg" id="auth-bg">
    <form class="auth-box" id="auth-form" autocomplete="off">
      <h2 id="auth-title">Sign In</h2>
      <input type="email" id="auth-email" placeholder="Email" required>
      <input type="password" id="auth-password" placeholder="Password" required>
      <button id="auth-submit" type="submit">Sign In</button>
      <button class="google-btn" id="google-signin" type="button">
        <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg">
        Continue with Google
      </button>
      <div class="switch-auth" id="switch-auth">Don't have an account? Sign Up</div>
      <div id="auth-error" style="color:#D32F2F;text-align:center;min-height:18px;font-size:0.98em;"></div>
    </form>
  </div>

  <!-- Main App UI (hidden before login) -->
  <div class="container" id="app-ui" style="display:none;">
    <!-- Sidebar -->
    <div class="sidebar">
      <button id="new-chat-btn">+ New Chat</button>
      <div class="chat-list">
        <div class="chat-list-title">Past Chats</div>
        <div id="chat-titles"></div>
      </div>
      <button class="logout-btn" id="logout-btn">Logout</button>
    </div>
    <!-- Chat Main -->
    <div class="chat-main">
      <div class="chat-area" id="chat-area">
        <!-- Welcome message -->
      </div>
      <form class="input-row" id="chat-form" autocomplete="off" style="display:none;">
        <input type="text" id="chat-input" placeholder="Type a message..." required autocomplete="off">
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <!-- Supabase & Google AI JS SDKs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.2/dist/umd/supabase.min.js"></script>

  <!-- Main JS Logic -->
  <script>
    // CONFIG: Supabase & Google Generative AI
    const SUPABASE_URL = 'https://pmzkmnmskumqseksmxdd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtemttbm1za3VtcXNla3NteGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4OTM1MDgsImV4cCI6MjA3NzQ2OTUwOH0.SMDY3kFXnHIeMrfRYks9_BUiyGMS9OBxej3PQXPXyqI';
    const GOOGLE_AI_KEY = 'AIzaSyDqxAWy_oilAAplzRQ26pdtMkfXxVjW7qg';

    // Supabase client init
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // App state
    let user = null;
    let currentChatId = null;
    let chatTitles = []; // [{id, title}]
    let chatsCache = {}; // {id: [{role,message}]}

    // --- Auth logic ---
    let isSignIn = true;
    document.getElementById('switch-auth').onclick = () => {
      isSignIn = !isSignIn;
      document.getElementById('auth-title').innerText = isSignIn ? "Sign In" : "Sign Up";
      document.getElementById('auth-submit').innerText = isSignIn ? "Sign In" : "Sign Up";
      document.getElementById('switch-auth').innerText = isSignIn ? "Don't have an account? Sign Up" : "Already have an account? Sign In";
      document.getElementById('auth-error').innerText = '';
    };

    // Sign In/Up form
    document.getElementById('auth-form').onsubmit = async (e) => {
      e.preventDefault();
      const email = document.getElementById('auth-email').value.trim();
      const pass = document.getElementById('auth-password').value;
      document.getElementById('auth-error').innerText = '';
      if (!email || !pass) return;
      try {
        let authRes;
        if (isSignIn) {
          authRes = await supabase.auth.signInWithPassword({ email, password: pass });
        } else {
          authRes = await supabase.auth.signUp({ email, password: pass });
        }
        if (authRes.error) throw new Error(authRes.error.message);
        user = authRes.data.user;
        showAppUi();
      } catch (err) {
        document.getElementById('auth-error').innerText = err.message;
      }
    };

    // Google OAuth
    document.getElementById('google-signin').onclick = async () => {
      document.getElementById('auth-error').innerText = '';
      // Start OAuth flow
      const { data, error } = await supabase.auth.signInWithOAuth({ provider: 'google' });
      if (error) document.getElementById('auth-error').innerText = error.message;
      // Supabase redirects to hosted UI, so on return, reload user
      // For HTML-only demo, reload after redirect
      setTimeout(() => location.reload(), 1000);
    };

    // Logout
    document.getElementById('logout-btn').onclick = async () => {
      await supabase.auth.signOut();
      location.reload();
    };

    // Show App UI after login
    async function showAppUi() {
      document.getElementById('auth-bg').style.display = 'none';
      document.getElementById('app-ui').style.display = '';
      document.getElementById('chat-form').style.display = '';
      // Get user info
      const { data: session } = await supabase.auth.getSession();
      user = session.session?.user || session.user;
      // Welcome message
      document.getElementById('chat-area').innerHTML = `
        <div class="message-row">
          <div class="chat-bubble ai">Hi! I’m AnythingWithAI, your AI assistant.</div>
        </div>
      `;
      // Load chats
      loadChats();
    }

    // On Load: check login
    (async () => {
      const { data: { user: currentUser } } = await supabase.auth.getUser();
      if (currentUser) {
        user = currentUser;
        showAppUi();
      } else {
        document.getElementById('auth-bg').style.display = '';
        document.getElementById('app-ui').style.display = 'none';
      }
    })();

    // --- Chat logic ---

    // Load chat titles from Supabase
    async function loadChats() {
      if (!user) return;
      const { data, error } = await supabase
        .from('chats')
        .select('id,title')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });
      chatTitles = data || [];
      renderChatTitles();
    }

    // Render sidebar chat list
    function renderChatTitles() {
      const el = document.getElementById('chat-titles');
      el.innerHTML = '';
      if (!chatTitles.length) {
        el.innerHTML = '<div style="color:#aaa;text-align:left;">No chats yet</div>';
        return;
      }
      chatTitles.forEach(chat => {
        const div = document.createElement('div');
        div.classList.add('chat-title');
        if (chat.id === currentChatId) div.classList.add('active');
        div.innerText = chat.title || "Untitled";
        div.onclick = () => openChat(chat.id);
        el.appendChild(div);
      });
    }

    // New Chat
    document.getElementById('new-chat-btn').onclick = () => {
      currentChatId = null;
      document.getElementById('chat-area').innerHTML = `
        <div class="message-row">
          <div class="chat-bubble ai">Hi! I’m AnythingWithAI, your AI assistant.</div>
        </div>
      `;
      document.getElementById('chat-input').value = '';
      renderChatTitles();
    };

    // Open a chat by id (load messages)
    async function openChat(id) {
      currentChatId = id;
      renderChatTitles();
      // Load messages from Supabase
      if (chatsCache[id]) {
        renderChatMessages(chatsCache[id]);
        return;
      }
      const { data, error } = await supabase
        .from('messages')
        .select('role,message')
        .eq('chat_id', id)
        .order('created_at', { ascending: true });
      chatsCache[id] = data || [];
      renderChatMessages(chatsCache[id]);
    }

    // Render messages in chat area
    function renderChatMessages(msgs) {
      const area = document.getElementById('chat-area');
      area.innerHTML = '';
      if (!msgs.length) area.innerHTML = `<div class="message-row"><div class="chat-bubble ai">Hi! I’m AnythingWithAI, your AI assistant.</div></div>`;
      msgs.forEach(msg => {
        area.innerHTML += `
          <div class="message-row">
            <div class="chat-bubble ${msg.role === 'user' ? 'user' : 'ai'}">${msg.message}</div>
          </div>
        `;
      });
      area.scrollTop = area.scrollHeight;
    }

    // Chat form submit
    document.getElementById('chat-form').onsubmit = async (e) => {
      e.preventDefault();
      const input = document.getElementById('chat-input');
      let userMessage = input.value.trim();
      if (!userMessage) return;
      input.value = '';
      // Show user message
      const area = document.getElementById('chat-area');
      area.innerHTML += `
        <div class="message-row">
          <div class="chat-bubble user">${userMessage}</div>
        </div>
        <div class="message-row ai-typing" id="typing-row">
          <div class="chat-bubble ai">
            <span class="typing"></span>
          </div>
        </div>
      `;
      area.scrollTop = area.scrollHeight;

      // Save user message to Supabase
      let chatId = currentChatId;
      // If new chat, create chat record
      if (!chatId) {
        // Save chat (title is first user message)
        const { data: chatData, error: chatErr } = await supabase
          .from('chats')
          .insert([{ user_id: user.id, title: userMessage }])
          .select().single();
        chatId = chatData?.id;
        currentChatId = chatId;
        chatTitles.unshift({id: chatId, title: userMessage});
        renderChatTitles();
      }
      // Save user message
      await supabase.from('messages').insert([
        { chat_id: chatId, user_id: user.id, role: 'user', message: userMessage }
      ]);
      // Call Google Generative AI (friendly, varied answer)
      let aiReply = await getAIResponse(userMessage);
      // Save AI message
      await supabase.from('messages').insert([
        { chat_id: chatId, user_id: user.id, role: 'ai', message: aiReply }
      ]);
      // Remove typing animation
      let typingRow = document.getElementById('typing-row');
      if (typingRow) typingRow.remove();
      // Show AI reply
      area.innerHTML += `
        <div class="message-row">
          <div class="chat-bubble ai">${aiReply}</div>
        </div>
      `;
      area.scrollTop = area.scrollHeight;
      // Update chat cache
      if (!chatsCache[chatId]) chatsCache[chatId] = [];
      chatsCache[chatId].push({role:'user',message:userMessage});
      chatsCache[chatId].push({role:'ai',message:aiReply});
    };

    // --- Google Generative AI API ---
    async function getAIResponse(prompt) {
      // Uses Gemini Pro API
      try {
        let res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + GOOGLE_AI_KEY, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            contents: [{
              role: 'user',
              parts: [{ text: prompt }]
            }]
          })
        });
        let data = await res.json();
        let text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
        // Fallback if no response
        if (!text) text = "I'm here to help! Can you rephrase your question?";
        return text.replace(/\n/g,"<br>");
      } catch (err) {
        return "Sorry, I couldn't reach my AI brain. Please try again.";
      }
    }

    // --- Supabase Table Structure ---
    // Table: chats { id (uuid), user_id (uuid), title (text), created_at (timestamp) }
    // Table: messages { id (uuid), chat_id (uuid), user_id (uuid), role (user/ai), message (text), created_at (timestamp) }
    // You need to create these tables in Supabase project.

  </script>
</body>
</html>